# 【BFS-X】ポジションを自炊して高速に売買を行うbitFlyerでの高速botフレームワーク(mmbotと高速スキャルピングbotのサンプルロジック付属)


---
## ２．ロジック部の構成（フレームワークを用いたロジックの記載方法）
---

BFS-Xでは、ユーザーがご自身のロジックを簡単なコードで記述することで容易にbotとして稼働させることが出来ます。  
同梱されているサンプルロジックなども参考にしてロジック部の構成を理解して、サンプルロジックを改良したり、ご自身のロジックを記載したりしてみてください。  
この章を理解するにはPythonの簡単なプログラミングの知識が必要ですが、<font color="red">**ロジックの動作を理解したうえで実際のbotの動作をみることは収支をプラスにすることに大変重要です**</font>。どのようなロジックなのかも理解していないままに闇雲にパラメータをいろいろと変えてみてもなかなか収支を改善することはできません。  
**まず起動させてみたい方は2章・3章・4章は飛ばして先に5章以降を読んでいただいてもよいですが**、是非サンプルロジックを動かす前にロジック部だけで良いのでコードを読んで理解してみることをお勧めします。

### ■ プログラムファイルとパラメータファイル 
ロジックは(1)プログラムファイルと(2)パラメータファイルのセットで構成されます。  
プログラムファイル(.py)には、Pythonで記述された実際のロジックコードを記載します。  
パラメータファイル(.yaml)にはbotやロジックの動作に関するパラメータファイルをyamlという記載方法を用いて記載します。BFS-Xの大きな特徴として、パラメータファイルはbot稼働時でも変更することが出来、変更すると自動的に読み込まれます。

### ■ クラスの形と、その中で用意する関数
ロジックは**MyStrategy**というClassとして記述します。
このClassには何個かの関数を用意してその中にロジックの中身を記載します。
各々の関数は決められたタイミングで呼び出されます。（イベントドリブンと呼ばれるプログラミングスタイル）  
BFS-Xではどの関数を用意するかによってmmbotモードか秒スキャモードが切り替わるようになっています。executions()関数が用意されていればmmbotモードで、なければ秒スキャモードまたはスイングモードになります。

* **initialize関数**：初回に１回だけ呼び出されます。ロジック内で使用する変数などの初期化をここで行います。

* **logic関数**：スキャモードおよびスイングモードの時にローソク足が確定したタイミングと、その後ロジックパラメータファイルの`logic_loop_period`で指定された間隔で呼び出されます。この関数内でローソク足のデータなどを元に売買判断を行って、売買関数を呼び出すことで実際の売買を行います。(mmbotモードの時には呼び出されません)

* **executions関数**：RealtimeAPIが約定履歴を受信したときに呼び出されます。  
この関数内でエントリー判断などを行い、オーダーを出したい場合にはself.order_signal_eventをセットします。（実際の売買はrealtime_logic関数内で行います）

* **board_updated関数**：RealtimeAPIが板情報の更新を受信したときに呼び出されます。（板情報のスナップショットを受信した場合と板情報の差分を受信した場合に呼び出されます）  
この関数内でエントリー判断などを行い、オーダーを出したい場合にはself.order_signal_eventをセットします。（実際の売買はrealtime_logic関数内で行います）

* **spot_executions関数**：RealtimeAPIが現物(BTC_JPY)の約定履歴を受信したときに呼び出されます。  
例えばSFDなどの現物価格に連動した判断が必要な場合に使用することが出来ます。  
ロジックパラメータファイルの`handle_spot_realtime_api`が`True`の時に有効です。

* **spot_board_updated関数**：RealtimeAPIが現物(BTC_JPY)の板情報の更新を受信したときに呼び出されます。（板情報のスナップショットを受信した場合と板情報の差分を受信した場合に呼び出されます）  
例えばSFDなどの現物価格に連動した判断が必要な場合に使用することが出来ます。  
ロジックパラメータファイルの`handle_spot_realtime_api`が`True`の時に有効です。

* **realtime_logic関数**：self.order_signal_eventがセットされたら呼び出されます。mmbotモードでの実際の売買はこの関数内で行います。

* **loss_cut_check関数**：mmbotモードの時には１秒に１回、スキャモードおよびスイングモードの時にはロジックパラメータファイルの`logic_loop_period`で指定された間隔で呼び出されます。定期的に判断すべき指標やロスカットの判断をこの関数内で行います。定期的なbotの稼働状況のロギングなどもこの関数で行うとよいでしょう。
戻り値として `True` を返すことでBFS-Xは`emergency_wait`で指定した秒数のノートレード期間に入ります。その際 `close_position_while_no_trade` を `True` に指定しておけば、現在持っているポジションを成行でクローズしてノーポジになります。

---
（以下の関数は BFS-X V6.00 以降で有効です）  

* **discord_on_message関数**：Discordのライブラリがインストールされていて、ロジックの設定ファイルに `discord_bot_token` が設定されている場合に、対象のDiscord botがメッセージを受信したら呼び出される関数。

* **discord_on_reaction_add関数**：Discordのライブラリがインストールされていて、ロジックの設定ファイルに `discord_bot_token` が設定されている場合に、対象のDiscord botがリアクションを検出したら呼び出される関数。

