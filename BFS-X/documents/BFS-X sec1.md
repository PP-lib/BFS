# 【BFS-X】ポジションを自炊して高速に売買を行うbitFlyerでの高速botフレームワーク(mmbotと高速スキャルピングbotのサンプルロジック付属)


---
## １．BFS-X概要説明
---


### ■ bitFlyer専用botのフレームワーク
このソフトは、Pythonで簡単なロジックファイルを作ることで容易に高速取引を行うbotを作成することが出来るbitFlyer専用botのフレームワークです。


### ■ 3つの動作モードをサポート
BFS-Xには3つの動作モードがあり、それぞれのモードは下記のようになっています。
  * **mmbotモード：** 約定通知や板の更新イベントに対して売買判断を行いリアルタイムに取引を行うモードです。秒足などのローソク足を判断基準として使用することも出来ます。

  * **秒スキャモード：** 1秒～数分未満のローソク足を自炊してローソク足更新時にローソク足のデータなどに従って取引を行うモードです。

  * **スイングモード：** 1分以上のローソク足を使用する場合に使うモードです。Cryptowatchから取得したローソク足データをもとに取引を行うモードです。

ロジックに合わせて最適な動作モードを選んでお使いいただくことが出来ます。


### ■ 自炊によるポジション管理
BFS-Xではwebsocketを使って流れてきたRealtimeAPIの約定履歴と自分の発注履歴を突き合わせてポジションを**自炊管理**し、getpositions(HTTP API)を使用して都度取得するよりも<font color="red">**迅速に正確なポジション管理**</font>を行います。

これによって<font color="red">**同一口座での複数稼働**</font>や、裁量取引とも共存することが可能です。また、getpositions(API)よりも<font color="red">**高速に何度も**</font>ポジション把握できるため高速な取引でもポジション違いによる逆選択のリスクを減らすことが出来ます。mmbotなどの高速高頻度取引では非常に重要なポイントです。

また、ポジション把握のためにAPIコールを行わないので、昨今のAPI回数制限などにおいても大変効果的に取引を行うことが可能です。

さらに、約定履歴をもとに建玉情報も自炊管理し、損益グラフもbotごと個別管理することが可能です。そのため同一ロジックを少しパラメータを変更して複数走らせて、それぞれのパラメータによる損益を個別に把握することが出来、単一口座でのABフォワードテストが容易に行えます。

Ctrl+Cでの中断時には現在のポジションをファイルに書き出し、再起動時には中断時のポジション情報から継続して稼働することが出来ます。

ネットワークの切断や、サーバーからの意図しないレスポンスなどによりポジションがズレることもあり得ますが、定期的にポジションを確認して、ずれたポジションを補正する機能があります。
```
注意）意図しないポジションズレにより発生したいかなる損失も補償しかねる事ご了承ください。
```


### ■ 豊富な付属サンプルロジック
4つのmmbot（派生ロジックを含めると8つ)と2つの秒スキャロジック（派生ロジックを含めると3つ)と3つのスイングロジックのサンプルロジックが付属しています。

これらのサンプルはフレームワークの使い方のサンプルであり、<font color="red">**このままの状態で利益で出ることを保証するものではありません**</font>が、実績のあるmmbotのロジックも含んでおり、mmbotとはどういうものかをご理解いただくには十分なサンプルだと思います。後述するように簡単にABテストを行うことが出来るのでパラメータの最適化などを行ったり、ご自身で独自の改良を加えることで十分に利益の出るロジックにすることが出来ると思います。

それぞれのサンプルロジックには簡単な説明がついており、このコードを読んでいただくことでBFS-Xでのロジックの記述方法や簡単なPythonのコード例をご理解いただくことが出来ます。

### ■ BFS-Xの機能と特徴
当フレームワークでは、リアルタイムAPIを用いたポジション管理のほか、bitFlyerで取引を行うために役立つ様々な機能を標準で用意しています。

#### リアルタイムAPI経由での板情報取得
 * Websocketにて板更新情報を取得しているため、HTTP APIアクセスを行わず（APIの回数制限の影響を受けず）何度でも迅速に板情報を取得して売買判定を行う事ができます。

#### 稼働パラメータのリアルタイム変更
* botやロジックの稼働パラメータは<font color="red">**botを再起動させること無く**</font>変更することが出来、細かいパラメータ調整も容易に行う事が可能です。

#### botの稼働状況の可視化
Discordへの定期的な稼働状況通知により、botの稼働状況を常にモニタリングすることが可能です。
 * 定期的に現在の損益グラフをプロットしてdiscordへ通知することが出来ます。 
 複数のbotを稼働した場合にもそれぞれのbotの損益グラフを個別に確認できるため、パラメータを変えてのABテストなども容易に行えます。通知間隔は変更可能です。
<img src="images/profit_graph.png" width="80%">

 * 損益グラフはbitFlyerのモバイルアプリの損益グラフに似せた表示にすることもできます。
<img src="images/profit_graph_bf.png" width="80%">

 * 損益グラフとは別に過去6時間のポジション推移、平均ポジション価格、LTP、損益グラフ、サーバーの遅延情報、APIアクセス回数をプロットしたグラフをプロットしてdiscordへ通知できます。
赤色が遅延が多めのところ、緑色が少ないところです。濃い赤色のところはSUPER BUSYが発生した期間です。  
API accessと記載のあるグラフの上にある点線が500回/5分のラインで、これを超える場合にはアクセス制限に引っかかる可能性があります
<img src="images/position_graph.png" width="80%">


#### botの統計情報の可視化
ロジックの改良や優位性の評価には様々な統計情報を可視化して判断することが大変重要です。BFS-Xでは様々な統計情報を可視化してロジックの改良への近道として使用いただけます
 * 1時間に1回、発注回数、約定回数、部分約定回数、apiアクセス回数などの統計情報をdiscordへ通知できます。
<img src="images/statistic.png" width="80%">

* 1時間に1回、apiのレスポンス速度をヒストグラムにプロットしてdiscordへ通知できます。
サーバーの状態変化や遅延状態を把握することが出来ます。
<img src="images/api_speed.png" width="80%">

* オーダー数・約定率・成行指値約定率をグラフにプロットしてdiscordへ通知できます。  
約定時スリッページ額も集計表示できます。トリガー価格に対してどの程度滑っているのか可視化することが出来ますので、ロットサイズの影響なども把握できます。青い丸が上にあるのは不利な約定、下にあるのは指値よりも有利に約定したテイク指値です。（最下段のプロット）  
<img src="images/order_rate.png" width="80%">

* オーダー時の板乗り時間とキャンセル時のキャンセル完了時間を統計情報としてプロットします。executionsの配信遅延と合わせてグラフ化しています。
<img src="images/order_delay.png" width="80%">

#### 高速な動作と低いCPU使用率
* CPUの使用率(aws t2.microにおける)はローソク足を生成するモードでは約3～7%(売買頻度による)、ローソク足を生成しないモードでは2～5%(売買頻度による)のCPU使用率です。頻度にもよりますが2つ程度の並行稼働はaws t2.microでも可能です。

#### サーバーの状態による取引制限
 * サーバーステータス["NORMAL", "BUSY", "VERY BUSY", "SUPER BUSY"]を指定して特定のサーバー状態では取引しない・緊急ポジションクローズするなどの指定ができます。
 * executionsの配信遅延を計測して数値化しており、それをもとに取引しない・緊急ポジションクローズするなどの売買判断が出来ます。

#### 特殊注文対応
* STOPオーダー、STOP_LIMITオーダー、TRAILオーダーのほか、OCO条件注文、IFD条件注文、IFDOCO条件注文などの特殊注文を用いたロジックもサポートしています。  
(※バックテストなど一部サポートしていない機能もあります)

#### 時刻・曜日による制御
* メンテナンス期間など決められた時刻には取引を停止する事が出来ます。時刻指定の他、曜日指定でも停止期間を設定可能です。
* 停止前にポジションをクローズするかしないかが選択可能です。

### ■ 使用言語
使用言語はPython3.6以降で以下のモジュールのインストールが必要です。
```
websocket-client
python-dateutil
pandas==0.24.2
pyyaml
matplotlib
requests
sortedcontainers
```
また、一部の機能を使用するためには、下記のライブラリのインストールも必要です。（Discordbot機能を使う場合、ポジションサーバー機能を使用する場合）
```
discord
influxdb
```
その他、指数の計算などのためにTA-Libなどもインストールされると良いかと思います。


### ■ 販売対象
ロジックのサンプルコードを読んで内容をご理解いただいた上で各自設定を変更したり、改良したり、さらにはご自身で独自のロジックを作っていただくことを目的としたフレームワークですので、<font color="red">**自身で簡単なプログラムがご理解頂ける方**</font>を対象にしております。

また、<font color="red">**環境構築はご自身で行える方**</font>を対象としております。AWSでの稼働やVPSでの稼働を前提としておりますが、Pythonが稼働できる環境であればローカルPCでの稼働などでも可能です

サポートは基本的には行わない形での販売形態といたしますが、購入者同士の情報交換や交流の場としてDiscordサーバーを立ち上げております。Discordサーバーでの情報交換を通して可能な範囲のフォローを行っております。

https://discord.gg/Evd5tRa

上記 Discord に参加後、下記の情報を「購入申請チャンネル」に書き込みください。
```
(1) 購入日時（時間はだいたいで結構です）  
(2) noteのニックネーム  
(3) noteのID  
```
確認後、購入者限定のチャンネルが見られるように権限の付与をいたします。  
バージョンアップなどの通知もこちらで行い、追加機能の配布・販売や、追加ロジックなどの配布・販売も検討しております。  

諸般の事情を鑑みて販売は休止または中止されることがあります。その際には [twitter: @kunmosky1](https://twitter.com/kunmosky1)にてアナウンスいたします。
