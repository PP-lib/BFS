# 【BFS-X】ポジションを自炊して高速に売買を行うbitFlyerでの高速botフレームワーク(mmbotと高速スキャルピングbotのサンプルロジック付属)


---
## ８．複数botの平行稼働（ポジションサーバーについて）
---


BFS-Xの大きな特徴として、ポジションを自炊管理してAPIアクセスを行わなくても現在のポジションを迅速に把握できる事が挙げられますが、websocketの切断やその他のトラブルなどにより、自炊しているポジションと実際のポジションが意図せずズレることがあります。  
このポジションズレのリスクを最小限に抑えるために、BFS-Xでは稼働パラメータファイルに ```adjust_position_with_api``` 設定があり、これを```true```にすることで定期的に(30秒に1回)APIでポジションを把握して、（一時的なズレではなく）ある程度連続してズレが確認されたらポジションズレが起きたものと判断して、ズレた量だけの成行売買発注を行いポジションを修正する機能があります。  

しかしながら、この機能は複数のbotを平行稼働させた場合には正しく機能することが出来ません。なぜなら各botは他のbotのポジションが分からず、現在ポジションがトータルでいくらであるべきかが分からないからです。  

この問題を解決すべくそれぞれのbotのポジションを集中的に管理するポジションサーバーが用意されています。


### ■ ポジションサーバーの動作
ポジションサーバーは一つのプログラムとして起動させておけば、ネットワーク経由で各botと通信を行います。

#### ●　合計ポジションの把握
各botは約定を検知してポジションが変化したら都度UDPソケット通信でポジションサーバーにポジションを連絡します。  
ポジションサーバーは各botから送られてきたポジション情報を合算して「現在ポジションがトータルでいくらであるべきか」を把握しておき、定期的に(30秒に1回)APIでポジションを把握して、（一時的なズレではなく）ある程度連続してズレが確認されたらポジションズレが起きたものと判断して、ズレた量だけの成行売買発注を行いポジションを修正します。(現在は4回連続してズレた場合、つまりズレたままで2分間経過後にポジションズレの修正を行います。)

#### ●　APIアクセス回数制限の把握
各botはポジションを送信する際に、自己が把握しているAPIアクセス回数制限の情報も合わせて送信します。  
ポジションサーバーは各botのAPIアクセス数をトータルして判断し、現在のAPIアクセス回数残を各botからの問い合わせに回答します。  
各botは10秒に1回 TCP/IPソケット通信でポジションサーバーにトータルAPI回数の問い合わせを行い、APIアクセス回数残が残っていない場合には取引を控えるようにします。  
これにより、複数bot稼働時にAPI回数制限にかからないように運用することが可能です。

#### ●　全botポジション合算のグラフの出力
ポジションサーバーでは一定間隔で全bot合計のポジションと損益をグラフ化してDiscordに送信することができます。

<img src="images/total.png" width="80%">

### ■ ポジションサーバーの使用方法
ポジションサーバーは```pos_server.py```および```trade.yaml```があるフォルダをカレントフォルダにして、```pos_server.py```を起動させることでスタートします。  

実行コマンド
```
python3 pos_server.py
```

稼働イメージ
<img src="images/pos_server.png">

ポジションサーバーはカレントフォルダにある ```trade.yaml``` ファイルの中で、apikey / secret の他、 pos_server / pos_server_graph_period / pos_server_discord / pos_server_discord_intervalの4つのパラメータを読み込んで動作します。

>[Tips1]  
起動時に引数として稼働パラメータを指定して起動することも可能です。  
下記の場合であれば、カレントフォルダにある ```trade.yaml``` の代わりに ```mytrade.yaml``` を稼働パラメータとして読み込むことが可能です。

>[Tips2]  
稼働パラメータは動作中での変更すればアップデートされますが、一部の設定は再起動しないと変更されません。  
起動中に変更可能なパラメータは ```pos_server_graph_period``` / ```pos_server_discord``` / ```pos_server_discord_interval``` / ```bitflyer_color``` の4つのみです。


実行コマンド
```
python3 pos_server.py mytrade.yaml
```


#### ●　pos_server :
ポジションサーバーを稼働させるホストのホスト名(またはIPアドレス)と通信に使用するポート番号を指定します。
通常はbotと同じサーバーでポジションサーバーを動作させるので、ホスト名(IPアドレス)は```'localhost'```にしておきます。  
ポートを番号はデフォルトでは```51000```となっていますが必要に応じて変更してください。
この項目はポジションサーバー側も参照しますし、各botも参照します。両者を同じポートで設定してください。

設定例（デフォルト）
```
pos_server : ['localhost', 51000]
```

> [Hint]   
デフォルトではpos_serverの項目はコメントアウトされています。コメントアウトされている場合には、botはポジションサーバーへの接続とポジション通知を行いません。  
ポジションサーバーを使う場合にはコメントアウトを解除してください。

> [Hint]   
異なるVPS間でBFS-X本体とポジションサーバーを稼働させる場合には、ポジションサーバーに使われる設定ファイル(trade.yaml)ではアドレスに **'0.0.0.0'** を指定することで、他のVPSからの接続も受信するようになります。  
ポジションサーバーデフォルトの状態で起動させた場合には設定ファイル(`trade.yaml`)はBFS-Xと共用になっていますので、起動時の引数で別の設定ファイルを指定してやるなどの工夫が必要です。
また、別のVPSで稼働しているBFS-Xの設定ファイルにはポジションサーバーが稼働しているVPSのIPアドレスを指定してやってください。  
**※その他、ファイヤーウォールの設定など適切なネットワーク設定が必要です。**

稼働設定例
<img src="images/pos_server2.png">

#### ●　pos_server_graph_period :
全botのポジション合算グラフを出力する際に、何時間分のグラフをプロットするかを指定します。  
デフォルトでは過去6時間のグラフをプロットする設定になっています。

> [Hint]   
ポジション合算グラフはマーケットごとにまとめられてプロットされます。例えば```BTC_JPY```で取引を行うbotと```FX_BTC_JPY```で取引を行うbotを稼働させた場合には、それぞれ2つのポジション合算グラフをプロット・送信します。

#### ●　pos_server_discord :
全botのポジション合算グラフおよび合算損益グラフを送信するdiscordのwebhookを指定します。  
デフォルトで記載している '' の状態であれば、通知は行いません。

#### ●　pos_server_discord_interval :
全botのポジション合算グラフおよび合算損益グラフを送信する間隔(分)を指定します。

#### ●　pos_server_discord_send_text :
各botの損益をテキストでDiscordへ通知するかを選択します。(true/false)  

#### ●　pos_server_bitflyer_color :
trueに設定すると合算損益グラフをbitFlyerのモバイルアプリのようなグラフ形式で出力します。(true/false)  
合算損益グラフは全マーケットの合算数値をプロットします。

#### ●　adjust_max_size :
ポジズレを補正する際に、一度に大きな成行売買を行わないように、一度に発注する最大量を指定することが出来ます。

#### ●　pos_server_discord_influxdb :
influxDBへポジション情報を出力する場合に使用します。  
詳細はこちらのnoteで紹介していますので参考にしてください。  
[InfluxDB + Grafana + ConoHa VPSで仮想通貨取引口座の損益グラフを管理する](https://note.com/kunmosky1/n/n3bda50a1f0e2)

設定例（デフォルト）
```
pos_server_discord_influxdb : ['localhost', 8086]
```

### ■ ポジションサーバーに接続しているbotの停止方法
ポジションサーバーに接続しているbotを```Ctrl+C```などで停止させた場合や何らかの異常でbotからの通信が来なくなった場合、最後の通信から300秒(5分)経過した場合にポジションサーバーは当該のbotをリストから削除します。  
ポジションを持ったままのbotがリストから削除された場合、その分だけポジションの合計がズレることになり、その後30秒ごとのポジションズレチェックである程度連続してズレが確認されたらポジションズレが起きたものと判断して、ズレた量だけの成行売買発注を行いポジションを修正します。(現在は4回連続してズレた場合、つまりズレたままで2分間経過後にポジションズレの修正を行います。)  
その結果、bot停止後7分程度でポジションズレのない正常な状態になります。

>[Tips]  
高頻度な取引の場合では停止からポジション適正化までの7分程度の間の変動で予期しない損益になることが考えられます。  
```close_position```パラメータなどを用いてポジションをゼロ（または影響ない程度に小さく）しておいてから停止させることをお勧めします。