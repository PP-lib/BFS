# 【BFS-X】ポジションを自炊して高速に売買を行うbitFlyerでの高速botフレームワーク(mmbotと高速スキャルピングbotのサンプルロジック付属)


---
## ７．ロジックパラメータファイル
---


各ロジックごとに異なる設定に関しては、ロジックごとのパラメータファイルで設定を変更することが出来ます。  
パラメータ類は（一部を除いて）稼働中でも変更でき、再起動の必要はありません。


### ■ ファイル形式
稼働パラメータファイルはYAML形式で記載されており、```項目名 : 値``` の形式で記載されています。


記述例
<img src="images/strategy_yaml.png">



















### ■ 設定パラメータ詳細
#### ●　parameters :
ロジックの中で読み込むパラメータをこのセクションに記載します。  
ロジックの判定基準などに使うパラメータをここに記載しておくことで、リアルタイムにパラメータを変更することが可能です。  

記述例
```python
parameters:
  short_sma : 7
  long_sma : 14
  lotsize : 0.1
```
上記の記載例であれば、ロジック内からは ```self._strategy_config['short_sma']``` などでパラメータにアクセス可能です。

> [Hint]  
パラメータの中で ```'lotsize'``` というパラメータは特定の意味を持たせています。  
```close_position```パラメータを用いてポジションクローズする際に、端数まで綺麗にポジションクローズさせるために、```'lotsize'```の3倍未満であれば成売買でクローズする動作を行います。  
エントリーロットを指定するパラメータは特別な理由がない限り ```'lotsize'``` という名前にしておくことをお勧めします。  


#### ●　timescale :
指定された秒足のローソク足を約定履歴から自炊します。  
自炊したローソク足データは self.open / self.high / self.low / self.close などのメンバ変数からアクセスします。（4章参照）  
ローソク足を用いないロジックの場合にはこのパラメータを0にしてください。ローソク足を生成しなくなり、CPUの負荷も低減されます。

> [Hint]  
あまり長いローソク足を自炊で生成するのは得策ではありません。  
なぜならば、例えば60分足のローソク足を自炊しようとする場合、最初の1時間は1時間分のデータを含まない不完全なローソク足となるからです。完全なローソク足が1本生成されるまでには最大で2時間を要する場合があり、取引がなかなか開始されないロジックになるでしょう。  
数分以上の長さの足を用いるロジックを作る場合には ```cryptowatch_candle``` パラメータを用いてCryptowatchからデータを取得する方がおススメです。


#### ●　numOfCandle :
timescale で指定して自炊するローソク足の本数を指定します。売買判定などに必要な長さを指定してください。


#### ●　renew_candle_everysecond :
`false` を指定した場合には、ローソク足の生成タイミングは次のローソク足に含まれるべき約定を受信した瞬間になり、その瞬間にその手前までのローソク足を閉じてlogic()が呼び出されます。この場合、長期間にわたって約定が無い区間などはその期間はlogic()が呼ばれないことになります。約定の有無にかかわらず一定間隔でlogic()を呼び出したい場合には、このパラメータを `true`に設定しておけば、取引が無い区間でも(OHLCはすべて同じ価格ですが）timescale期間でlogic()を呼び出すようなります。（間隔はそこまで正確ではなく多少のタイミング誤差はあります）


#### ●　cryptowatch_candle :
このパラメータがある場合には、BFS-Xは定期的にCryprtowatchからデータを取得します。取得されたデータは ```self.cryptowatch_candle``` からアクセス可能です。（4章参照）  
Cryptowatchからのデータ取得はバックグラウンドで行われ、実際にCryptowatchからデータを取得するのは、足が更新されるタイミングの前後数回だけですので、self.cryptowatch_candleへは何度アクセスしても通信は発生しません。

> [Hint]   
Cryptowatchが配信しているデータは1時間足,30分足,15分足,5分足,3分足,1分足ですが、BFS-Xではこれらをもとに自動的にリサンプリングする機能がありますので、自由な時間足（分）が指定可能です。  
例えば45と指定したら、15分足をCryptowatchから取得してきて3本ずつを合わせて自動的に45分足を生成します。8分足を指定したら1分足を取得して8本ずつを合わせて計算、という具合です。

#### ●　cryptowatch_numOfCandle :
Cryprtowatchからローソク足を取得する際に何本のデータを取得するかを指定します。
> [Hint1]   
Cryptowatchは無料サービスですが1時間あたりに取得できるデータ量に制限がありますので、必要以上に多くしないようにしておくことが大切です。

> [Hint2]   
BFS-Xでのリサンプリングも考慮していますので、例えば9分足を10本必要とする場合には cryptowatch_candle:9 で cryptowatch_numOfCandle:10 と指定しておけば、BFS-Xでは3分足を30本して、内部的に9本足を10本生成します。


#### ●　fill_nan :
メンテ期間などでCryptowatchのデータが欠落している場合に、その区間を（前のローソクで）補完するかどうかを指定します。
```false``` を指定すると補完しないので、メンテ期間などがある場合には取得されるローソク足の本数は少なくなります。
```true``` を指定するとメンテ期間にかかわらず一定の本数のデータが用意されます。


#### ●　logic_loop_period :
何秒間隔でロジックループを回すかを指定します。  
ロジックループとは 、秒スキャモードおよびスイングモードの場合でのlogic()関数の呼び出し、apiカウンタの残量確認、約定済みリストと発注済みリストを突き合わせて現在ポジを再計算、loss_cut_check()関数の呼び出しなどの一連の動作ループです。  
なお、logic_loop_periodを1秒以下にしてもloss_cut_check()は1秒に1回以上は呼び出されません

>[Hint1]  
未確定足のデータを用いて取引判断を行いたい場合には、 ```timescale``` よりも短い数値を設定することで、その間隔でlogic()関数が呼び出されます。例えば、ローソク足は60秒(1分)足を生成するけれど、(ローソク足確定前の)直近の急変などでドテンしたい場合などは```logic_loop_period```を例えば 5 に設定すれば、5秒ごとに(未確定足のデータを元に)売買判断をやり直すロジックにすることが出来ます。  

>[Hint2]  
```logic_loop_period``` がいくらであっても ```timescale``` 秒の数秒前には待機状態になりローソク足確定を待ち、ローソク足が確定した直後にlogic()関数が呼び出されます。

>[Hint3]  
BFS-Xでの自炊ポジションは RealtimeAPI を受信した瞬間にカウント更新されますが、ロジックループの中で念のため約定済みリストと発注済みリストを突き合わせて現在ポジを再計算しています。

#### ●　drive_by_executions :
mmbotモードで有効です。Trueに設定した場合には、自分のオーダーが約定したときにrealtime_logic()関数が呼び出されるようになります。  
realtime_logic()関数内で self.execution_event.is_set() をチェックして、Trueであれば self.execution_event.clear() でイベントをクリアしてください。クリアしないと次のイベントを受け取れません。  
サンプルロジックのmm_std2.pyに使用例がありますので参考にしてください。

#### ●　drive_by_spot_ticker :
mmbotモードで有効です。Trueに設定した場合には、websocketで現物のtickerを受信したときにrealtime_logic()関数が呼び出されるようになります。
realtime_logic()関数内で self.spot_ticker_event.is_set() をチェックして、Trueであれば self.spot_ticker_event.clear() でイベントをクリアしてください。クリアしないと次のイベントを受け取れません。

#### ●　handle_spot_realtime_api :
Trueに設定した場合には、websocketで現物板の約定履歴と板情報の更新も受信し、それぞれ。約定履歴受信時にはspot_executions関数、板情報の更新時はspot_board_updated関数を呼び出します。

#### ●　minutes_to_expire :
発注するオーダーの有効期間を設定します。(単位：分)  
子注文、親注文いずれのオーダーにも有効です。


#### ●　order_retry :
オーダー時の最大リトライ回数を指定します。（指定していないときのデフォルトは30回。0を指定した場合にはリトライを行いません。）


#### ●　cancel_retry :
キャンセル時の最大リトライ回数を指定します。（指定していないときのデフォルトは10回。0を指定した場合にはリトライを行いません。）

#### ●　ranking_discord_id :
ランキングサーバーに送信する際にDiscordIDを指定します。

#### ●　ranking_botname :
ランキングサーバーに送信する際のbot名を指定します。

#### ●　ranking_report_interval :
ランキングサーバーに損益を送信する間隔（分）を指定します。
>[Hint]  
頻繁に損益を送ることで損益グラフの形からロジックの内容が分かってしまう様な事を懸念される場合には送信間隔を長くすることが出来ます。（例：180なら3時間に1回の送信)  

>[Hint]  
ランキングサーバーは１時間ごとに損益サーバーにデータ送信があるかどうかでランキングポイントを算出しています。最低1時間以内に１回以上の頻度で損益を送信するbotが最低１つは無ければランキングポイントの加算が不十分になります。  
長くても `ranking_report_interval` の値は60にしておくことをお勧めします。


#### ●　normal_state :
取引所の状態( NORMAL / BUSY / VERY BUSY / SUPER BUSY など)のうち、取引を行ってもよい状態を指定します。

設定例(NORMAL/BUSY/VERY BUSYの時だけ取引OK、SUPER BUSYは取引停止)
```python
normal_state : ["NORMAL", "BUSY", "VERY BUSY"]
```
>[Tips]  
取引所の状態取得に失敗した場合には ```"FAIL"```、起動直後でまだ取引所の状態を取得していないときには ```"OTHER"``` になっていますので、   
normal_state : ["NORMAL", "BUSY", "VERY BUSY", "SUPER BUSY", "FAIL", "OTHER"]  
と指定することで全ての状態で取引OKとすることが出来ます。

#### ●　emergency_state :
取引所の状態( NORMAL / BUSY / VERY BUSY / SUPER BUSY など)のうち、ポジションを緊急クローズする状態を指定します。

設定例(SUPER BUSYの時はポジションを緊急クローズ)
```python
emergency_state : ["SUPER BUSY"]
```
>[Tips]  
ありえない設定（例えば ```"NONE"``` など)を指定することで、緊急クローズの機能は発動しなくなります。  
emergency_state : ["NONE"] 


#### ●　latency_limit :
BFS-Xではexecutionsの配信に入っているタイムスタンプと自サーバーの時刻を比較して常時配信遅延を計測しており、その遅延状況によって遅延が一定値を超えた場合にポジションを緊急クローズすることができます。  
なお、単純に時刻の差分を計測するだけだと自サーバーの時計設定がズレていたり、タイムゾーンがズレていればそのズレ量も遅延として判定されますが、BFS-Xでは過去10分に記録した最小の数値（そのサーバーでの最速値）に対して直近10秒の遅延がどの程度大きいかを判断しています。  
ロジック内からは ```self.server_latency``` 変数へのアクセスで生の遅延値が取得でき、 ```self.server_latency_rate``` 変数へのアクセスで最速値よりもどの程度遅れているかが取得できます。この ```self.server_latency_rate``` 値が ```latency_limit``` で指定した値よりも大きくなればbot側で現在ポジを成り行きで全決済してノーポジになろうとします。


#### ●　emergency_wait :
緊急ポジションクローズのために成り行きで決済注文を出した際に、通常ではサーバーは混雑しているのですぐに現在ポジションには反映されません。（約定履歴が遅れて届くのでポジションは遅れて反映されます）。  
そのため、成り行き決済後、再度現在ポジが残っていると思って成り行き決済を行ってしまうと2重決済になって逆ポジを持ってしまいます。ここで数値（秒数）を指定しておくことで、成り行き決済後には一定秒数のノートレード期間を設けることが出来ます。一般的には30～120秒程度を指定しておくのが良いと思われます。


#### ●　close_position_while_no_trade :
BFS-X稼働パラメータファイル(```trade.yaml```)でトレード停止期間を指定している場合、そのトレード停止期間に入ったさいに持っていたポジションをクローズするかどうかを指定します。(true/false)  
短期間に取引を行うmmbotなどではノートレード期間の価格変動リスクを避けるためにノーポジションにするほうが安全ですが、長期間の取引を行うスイングロジックなどではノートレード期間でもポジションを保持する方が良いでしょう。


#### ●　close_position :
稼働中にこのパラメータをtrueにすると、新規の（ポジを増やす方向の）エントリーは行わなくなり、エントリー頻度にもよりますが徐々にポジションをクローズさせていきます。  
最後のポジションは端数を的確にクローズするために['lotsize']の3倍以下のポジションであれば成り行きで決済を行いますが、比較的安全にロジックに沿ってポジションクローズを試みてみようという機能です。  


#### ●　log_folder :
ログやその他、ロジックの動作のために必要なポジション情報や中断時に保存される一時データなどを保存するフォルダを指定します。  
複数のロジックを平行稼働させる場合には重複しないように設定してください。フォルダの最後にはスラッシュが必要です。


#### ●　log_level :
ログに保存されるログレベルを指定します。( DEBUG / INFO / WARNING / ERROR )  
デバッグファイルに情報が多すぎると感じる場合にはデバッグレベルを落とすことで指定されたレベル未満の情報は出力しないようにすることができます。

>[Hint]  
ログファイルは1日に1回ローテーションされて、zip圧縮して保存されます。圧縮されるとかなり小さくなるので、DEBUGにしておいてもそこまでディスク容量を圧迫することはないでしょう。  
何か問題があった際に確認できるようDEBUGにしておくことをお勧めします。


#### ●　profit_discord_webhooks :
Discordのwebhookを指定することで、定期的にポジション損益グラフをDiscordに送信します。  
デフォルトで記載している '' の状態であれば、通知は行いません。


#### ●　profit_interval :
ポジション損益グラフを出力する間隔を指定します。設定できる数値は1～60で、単位は分です。0を指定すると日付が変わったときに１度だけ出力することができます（日次）


#### ●　disp_realized_profit :
損益グラフに確定損益（含み益を含まない損益）のグラフもプロットするかどうかを選びます。(true/false)


#### ●　disp_position :
損益グラフにポジション履歴もプロットするかどうかを選択します。(true/false)


#### ●　bitflyer_color :
trueに設定すると損益グラフをbitFlyerのモバイルアプリのようなグラフ形式で出力します。(true/false)


#### ●　position_discord_webhooks :
ポジショングラフを出力するdiscord webhookを指定します。  
デフォルトで記載している '' の状態であれば、通知は行いません。  
このdiscordには1時間に1回の取引統計情報とAPI処理速度のヒストグラムも送信されます。例えばこちらのdiscordに送られてくる情報は詳細過ぎてロジックが丸わかりになってしまいますので非公開として```profit_discord_webhooks```で指定したほうの損益グラフだけを公開するなどの使い方のために```profit_discord_webhooks```と```position_discord_webhooks```の指定を分けています。両方同じところに配信しても問題なければ両方同じdiscord webhookを記載しても問題ありません。


#### ●　position_interval :
ポジショングラフを出力する間隔を指定します。設定できる数値は1～60で、単位は分です。0を指定するとポジションのグラフ・API処理速度のヒストグラム・オーダーレスポンスなどのグラフは送信しないようにすることが出来ます。（スイングのロジックなどで不要な場合）


#### ●　display_normal :
ポジショングラフの背景はサーバーのビジー状態を示しています。  
```server_latency_rate``` 値がこの数値以下（単位はmsec）であれば緑色に描画されます。


#### ●　display_busy :
ポジショングラフの背景を赤色（薄い赤色）にする閾値を指定します。  
```server_latency_rate```値がこの数値以上（単位はmsec）であれば赤色（薄い赤色）に描画されます。   
なお、濃い赤色は ```server_latency_rate```値ではなく取引所の状態でSUPER BUSYが観測された時間帯を示しています。

#### ●　websocket_connect :
Websocket接続が確立した際のDiscord送信時に付加するメンションを指定することが出来ます。通知設定などと合わせて活用することが出来ます。
```
[設定例]
websocket_connect: '@everyone'
```

>[Tips]   
メンションの指定は特定の個人（例えば自分自身）へ宛てること可能です。
その場合にはこのようにユーザーIDを指定します。
```
websocket_connect: '<@433559644322136084>'
```
>ユーザーIDの確認方法は  
ユーザー設定 →　テーマ　→　開発者モード　をONにして
ユーザーのアイコンを右クリックすると出てくるIDをコピーを選択するとクリップボードにコピーすることが出来ます。

<img src="images/setting1.png" width="50%">  
<img src="images/setting2.png" width="100%">  
<img src="images/setting3.png" width="50%">

#### ●　websocket_close :
Websocket接続が切断された際のDiscord送信時に付加するメンションを指定することが出来ます。通知設定などと合わせて活用することが出来ます。ユーザーIDを指定することで特定の個人へメンションすることも出来ます。
```
[設定例]
websocket_close: '@everyone'
```

#### ●　websocket_auth :
Private Channelの認証が成功した際のDiscord送信時に付加するメンションを指定することが出来ます。通知設定などと合わせて活用することが出来ます。ユーザーIDを指定することで特定の個人へメンションすることも出来ます。

```
[設定例]
websocket_connect: '@everyone'
```

#### ●　plot_delay :
グラフをプロットする際に、プロット開始時間をずらすことが出来ます。（秒）
この項目が無ければ、ちょうど00分などに稼働中の全てのBFS-Xがグラフのポジショングラフや損益グラフ、統計情報などのグラフプロットを行うのでCPU負荷が高まり、場合によってはエントリー遅れ等が発生する可能性があります。そういう場合にはこの値を指定することで例えば30秒ずらしてグラフの生成を開始させることが可能です。
```
[設定例]
plot_delay: 30
```

#### ●　plot_execute_rate :
約定率・テイク約定率のグラフをプロットするかしないかを(True/False)で指定します。  
なお、position_interval に 0 を指定する事でもポジショングラフとその他の統計情報をまとめてプロットしないようにさせることが出来ます。ポジショングラフは出力したいが、そのほかの統計情報は出す必要が無い場合などにこのパラメータで個別にプロットする/しないを指定してください。  

<img src="images/plot_execute.png" width="50%">  

```
[設定例]
plot_execute_rate: False
```


#### ●　plot_api_speed :
APIレスポンス速度のヒストグラムをプロットするかしないかを(True/False)で指定します。  
なお、position_interval に 0 を指定する事でもポジショングラフとその他の統計情報をまとめてプロットしないようにさせることが出来ます。ポジショングラフは出力したいが、そのほかの統計情報は出す必要が無い場合などにこのパラメータで個別にプロットする/しないを指定してください。  

<img src="images/plot_api.png" width="50%">  

```
[設定例]
plot_api_speed: False
```

#### ●　plot_order_event :
オーダー・キャンセルイベントのグラフをプロットするかしないかを(True/False)で指定します。  
なお、position_interval に 0 を指定する事でもポジショングラフとその他の統計情報をまとめてプロットしないようにさせることが出来ます。ポジショングラフは出力したいが、そのほかの統計情報は出す必要が無い場合などにこのパラメータで個別にプロットする/しないを指定してください。  

<img src="images/plot_order.png" width="50%">  

```
[設定例]
plot_order_event: False
```


