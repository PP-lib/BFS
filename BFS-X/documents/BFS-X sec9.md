# 【BFS-X】ポジションを自炊して高速に売買を行うbitFlyerでの高速botフレームワーク(mmbotと高速スキャルピングbotのサンプルロジック付属)


---
## ９．バックテスト機能について（おまけ機能）
---


BFS-Xにはバックテスターが付属しています。  
しかしながら、BFS-Xの豊富なAPIを全て再現できていないことから、バックテストできるロジックは一部のロジックに限られます。  
あくまでおまけの機能としてお考えください。

>[Hint]  
サポートしているのはBFS-Xの動作モードのうち、**スイングモード**と**秒スキャモード**と**mmbotモード**をサポートしています。  
同梱しているサンプルロジックフォルダ(strategyフォルダ)にバックテスト結果の画像が入っているものはバックテスト対応しています。

### ■ スイングモードロジックのバックテスト

スイングモードロジックのバックテストは ```backtest_cryptowatch.py``` (と```backtest_cryptowatch.yaml```) を用いて行います。  
バックテスト用のデータは都度Cryptowatchから取得して実施され、直近の指定された本数のローソク足を持ちてバックテストが行われます（期間の指定は出来ません）  

以下にパラメータファイル(```backtest_cryptowatch.yaml```)の記述方法を説明します。
#### ●　strategy_py :
読み込むロジックファイルを指定します。カレントフォルダからの相対パスで指定してください。

#### ●　strategy_yaml :
読み込むロジックパラメータファイルを指定します。カレントフォルダからの相対パスで指定してください。

#### ●　optimize :
バックテスターの最適化機能のための設定です。後述するバックテスターの最適化機能の説明項目を参照してください。

#### ●　slipage :
成売買でのスリッページ(円)を指定します。

#### ●　backtest_resolution :
Cryptowatchから取得するローソク足の長さ（分）を指定します。  
ロジックで使用するローソク足の長さと同じか整数倍の足の長さを指定してください。  
(30分足のロジックなら30/60/120...など)


#### ●　backtest_candles :
バックテスト用に取得するローソク足の本数 (最大約6000)をしていします。  
解像度60分足なら6000本で約8か月、解像度30分足なら6000本で約4か月、解像度15分なら6000本で約2か月、解像度5分なら6000本で約20日と、おおまかな期間指定に使用することが出来ます。


#### ●　output_files :
ファイル名を指定すると、バックテスト結果のプロットをファイルに出力します。  
''（空欄）の指定を行った場合には、バックテスト結果は画面に出力されます。


### ■ 秒スキャモードロジックのバックテスト

秒スキャモードロジックのバックテストは ```backtest_scalpingmode.py``` (と```backtest_scalpingmode.yaml```) を用いて行います。

バックテスト用のデータは別途約定履歴のファイルを用意する必要があります。
約定履歴を取得するスクリプトはこちらのスクリプトを利用して取得したデータが使用可能です。

[通常の3倍速いバックテストのための約定履歴データを作るPython3スクリプト https://note.com/kunmosky1/n/ne8915a6f6ff2](https://note.com/kunmosky1/n/ne8915a6f6ff2)

(executions/exec-pack_2019-12-14.csv に動作確認用として1日分のデータが同梱されています。)

以下にパラメータファイル(```backtest_scalpingmode.yaml```)の記述方法を説明します。
#### ●　strategy_py :
読み込むロジックファイルを指定します。カレントフォルダからの相対パスで指定してください。

#### ●　strategy_yaml :
読み込むロジックパラメータファイルを指定します。カレントフォルダからの相対パスで指定してください。

#### ●　optimize :
バックテスターの最適化機能のための設定です。後述するバックテスターの最適化機能の説明項目を参照してください。

#### ●　delay :
バックテスト時の遅延評価の係数を指定します。  
1.0が標準で、大きくすると遅延に対して厳しく評価します。(エントリー・約定が遅れるように評価)  
小さくすると遅延に対して甘く評価し、0.0にすると遅延無しの場合の結果になります。  
0.0～2.0程度で評価してみてください。

#### ●　slipage :
成売買でのスリッページ(円)を指定します。

#### ●　data_folder :
約定履歴を入れておくフォルダを指定します。カレントフォルダからの相対パスで指定して、最後はスラッシュにしてください。

#### ●　execution_files :
読み込む約定履歴ファイルを順に列記します。  
複数記述することで複数日のバックテストが可能ですが、長い期間のバックテストを行うには多くのメモリを必要とします。

記述例
```
execution_files:
  - file: exec-pack_2019-12-14.csv
  - file: exec-pack_2019-12-15.csv
  - file: exec-pack_2019-12-16.csv
```

#### ●　fix_timescale :
グラフの横軸を正確な時刻にするかどうかを指定します。(true/false)
trueにした場合には、プロット時に時間がかかりますが、横軸は正確な時間軸になります。  
高速に評価する場合にはfalseにすれば横軸は約定回数になります。


#### ●　output_files :
ファイル名を指定すると、バックテスト結果のプロットをファイルに出力します。  
''（空欄）の指定を行った場合には、バックテスト結果は画面に出力されます。


### ■ mmbotモードロジックのバックテスト
mmbotモードのバックテストは今のところ未公開ですが、要望が多いようでしたら別途販売を検討いたします。


<div style="page-break-before:always"></div>

----

### ■ パラメータ最適化機能(全モード共通)

BFSのバックテストでは、ロジックパラメータファイルのパラメータを変更して結果を確認する機能があります。

バックテスト設定ファイル(.yaml)のoptimize欄に変更したいパラメータを記載して、[開始値、終了値(この値未満で終了)、増値]を指定すれば、指定されたパラメータ(下記の例では```mfi_limit```を順次変更して(下記の例では0～29まで1ずつ変更)して全てのパラメータでバックテストを行います。  
その後、全ての損益グラフと、指定したパラメータを横軸・損益を縦軸にしたサマリーグラフを出力します。

記述例
```
optimize:
  mfi_limit : [0,30,1]
```
実行例  
<img src="images/optimize.png">
<div style="page-break-before:always"></div>


出力例  
<img src="images/output.png">


サマリープロット例  
<img src="images/mfi_limit.png" width="70%">
<img src="images/depth.png" width="70%">

----

### ■ 全パラメータ組み合わせ評価機能(全モード共通)

パラメータ最適化機能ではそれぞれのパラメータを変更した場合の結果をグラフプロットして、パラメータ一を１つずつを評価して決めていくやり方を行いますが、この全パラメータ組み合わせ評価機能は、時間は掛かりますが全ての組み合わせを評価していくやり方です。

出力した結果は[しんじろさん](https://note.com/shinjiro_tigers)が販売されているnoteの有料部分などでも紹介されているように縦横のマトリックスに並べて評価するようなことも可能です。

<img src="images/combination.png" width="70%">

全パラメータ組み合わせ機能は、通常のバックテストコードをクラスモジュールとして扱い、それを呼び出す事で実現しています。（このアイデアは[さぼりーまんパパさん](https://twitter.com/akihirot1)のこちらのnoteを参考にさせていただきました。)  

> Optuna(TPE)を利用したバックテストによるBOTトレードのパラメータ最適化について: [https://note.com/akt1/n/n8731e8083b6b](https://note.com/akt1/n/n8731e8083b6b)

スイングモードロジックの場合の組み合わせバックテストは ```backtest_cryptowatch.py```の代わりに```backtest_cryptowatch_combi.py```を、秒スキャモードロジックの場合の組み合わせバックテストは ```backtest_scalpingmode.py``` の代わりに```backtest_scalpingmode_combi.py```を使用する事で総組み合わせの評価を行うことが出来ます。

評価されるパラメータの指定方法はパラメータ最適化機能と同じでバックテスト設定ファイル(.yaml)のoptimize欄に変更したいパラメータを記載して、[開始値、終了値(この値未満で終了)、増値]を指定することで可能です。

実行例  
<img src="images/combi1.png" width="70%">

出力例  
<img src="images/combi2.png" width="70%">
